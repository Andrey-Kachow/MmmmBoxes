# Always install pre requisite stuff, and run local database test and sanity check test
.preamble: &preamble
  - python3 -m venv venv
  - source venv/bin/activate
  - pip install --upgrade pip
  - pip install -r test/requirements.txt
  - pip install -r requirements.txt
  - export DATABASE_URL="postgres://gitlab-runner:memes@localhost:5432/postgres"
  - apt install tesseract-ocr -y
  - apt install imagemagick

.on-master-or-merge: &on-master-or-merge
  - if: $CI_COMMIT_BRANCH == "master" #don't change me
  - if: $CI_PIPELINE_SOURCE == "merge_request_event" #don't change me
  - if: $CI_COMMIT_BRANCH == "dev"

# These 2 basic tests run all the time to make sure things haven't gone up in flames after a commit
local-db-test:
  stage: test
  script:
    - *preamble
    - pytest test/basic/test_local_db_connection.py

sanity-test:
  stage: test
  script:
    - *preamble
    - pytest test/basic/test_sanity.py

test-db:
  stage: test
  script:
    - *preamble
    - pytest test/test_db.py
  rules:
    - *on-master-or-merge
    - changes:
      - main/database/**.*

test-signatures:
  stage: test
  script:
    - *preamble
    - pytest test/test_signatures.py
  rules:
    - *on-master-or-merge
    - changes:
      - main/database/**/*

test-template:
  stage: test
  script:
    - *preamble
    - pytest test/test_replacement.py
  rules:
    - *on-master-or-merge
    - changes:
      - main/app/populate_template.py

test-ocr:
  stage: test
  script:
    - *preamble
    - pytest -s test/test_ocr.py
  rules:
    - *on-master-or-merge
    - if: $CI_COMMIT_BRANCH == "feat/ocr_parcel"
    - changes:
      - main/app/ocr.py
      - test/test_ocr.py

# ##############################

# # Below are examples of non-compulsory tests.
# # Note: for safety, they must ALWAYS run on merge requests or master branch.

# # RUN ON FILE CHANGE
# app-main-test:
#   stage: test
#   script:
#     - *preamble
#     - echo "Ran whenever changes are detected"
#   rules:
#     - *on-master-or-merge
#     - changes:
#       - app/main.py

# # RUN ALWAYS ON BRANCH
# run-on-branch-test:
#   stage: test
#   script:
#     - *preamble
#     - echo "Ran on specific branch"
#   rules:
#     - *on-master-or-merge
#     - if: $CI_COMMIT_BRANCH == "YOUR_BRANCH"

# ############################


# Deploy to heroku if pushed to master branch.
deploy-master:
  stage: deploy
  script:
    - dpl --provider=heroku --app=drp11 --api-key=$MS_API_KEY
  rules:
    - if: $CI_COMMIT_BRANCH == "master"

deploy_dev:
  stage: deploy
  script:
    - dpl --provider=heroku --app=drp11-dev --api-key=$MS_API_KEY
  rules:
    - if: $CI_COMMIT_BRANCH == "dev"
